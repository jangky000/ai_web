<%@page import="nation.web.tool.DBClose"%>
<%@ page contentType="text/html; charset=UTF-8"%>

<%@ page import ="nation.web.notice1b.NoticeVO" %>
<%@ page import ="nation.web.notice1b.NoticeDAO" %>

<% 
request.setCharacterEncoding("utf-8"); 
String root = request.getContextPath();
%>

<%
NoticeDAO noticeDAO = new NoticeDAO();
NoticeVO noticeVO = new NoticeVO();
%>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title></title>
<link href="<%=root%>/css/style.css" rel="Stylesheet" type="text/css">
</head>
<body>
  <jsp:include page="/menu/top.jsp" flush='false' />
  <div class="title_line">공지사항 ver 1.0b</div>
  <fieldset class="fieldset_basic">
    <!-- <legend class="legend_basic">공지사항 등록</legend> -->
    <ul>
      <%
        int noticeno = Integer.parseInt(request.getParameter("noticeno"));
        String passwd = request.getParameter("passwd");

        boolean isPasswdcheck = false;
        int count = 0;
        
        noticeVO.setNoticeno(noticeno);
        noticeVO.setPasswd(passwd);
        
        isPasswdcheck = noticeDAO.passwdCheck(noticeno, passwd);
        
        
        if (isPasswdcheck == true) { // 패스워드 일치
          count = noticeDAO.delete(noticeVO);
        
          if (count == 1) {
            %>
            <li class="li_none">삭제 처리에 성공했습니다.</li>
            <%
          } else {
            %>
            <li class="li_error">삭제 처리에 실패했습니다.</li>
            <li class="li_none">다시 시도해주세요.</li>
            <%
          }
        } else { // 패스워드 불일치
          System.out.println("비밀번호 일치하지 않음");
          %>
          <li class="li_error">비밀번호가 일치하지 않습니다.</li>
          <li class="li_none">다시 시도해주세요.</li>
          <%
        }
      %>
      
      
      
      
      
        
        //네트워크 설정에 예외처리가 필수
        try {
          con = new DBOpen().getConnection();

          // 패스워드 검사
          sql = new StringBuffer();
          //SQL문 앞에 한 칸 공백 만들기 + ' ; '지우기
          sql.append(" SELECT COUNT(*) AS passwd_cnt");
          sql.append(" FROM notice");
          sql.append(" WHERE noticeno=? AND passwd=?");

          //StringBuffer를 문자열로 변환
          pstmt = con.prepareStatement(sql.toString());
          pstmt.setInt(1, noticeno);
          pstmt.setString(2, passwd);

          rs = pstmt.executeQuery();
          rs.next();
          passwd_cnt = rs.getInt("passwd_cnt");

          if (passwd_cnt == 1) { // 패스워드 일치
            // 수정처리
            sql = new StringBuffer();
            //SQL문 앞에 한 칸 공백 만들기 + ' ; '지우기
            sql.append(" DELETE FROM notice");
            sql.append(" WHERE noticeno=?");

            //StringBuffer를 문자열로 변환
            pstmt = con.prepareStatement(sql.toString());
            pstmt.setInt(1, noticeno);

            //pstmt 바인딩 후에 실행
            count = pstmt.executeUpdate(); // INSERT, UPDATE, DELETE를 실행

            if (count == 1) {
      %>
                  <li class="li_none">삭제 처리에 성공했습니다.</li>
                <%
              } else {
                %>
                  <li class="li_error">삭제 처리에 실패했습니다.</li>
                  <li class="li_none">다시 시도해주세요.</li>
                <%
              }
            } else { // 패스워드 불일치
              System.out.println("비밀번호 일치하지 않음");
              %>
                <li class="li_error">비밀번호가 일치하지 않습니다.</li>
                <li class="li_none">다시 시도해주세요.</li>
              <%
        }

        } catch (SQLException e) {
          System.out.println("SQL 실행 중 예외 발생");
          e.printStackTrace(); // 예외가 발생하기까지의 실행 과정 출력
        } finally {
          new DBClose().close(con, pstmt);
        }
      %>

    </ul>
    <div class="bottom_menu">
      <!-- onclick = "" javascript 연결 -->
      <%
        if(passwd_cnt == 0 || count == 0){
          %>
          <button type="button" onclick="history.back();">다시 시도</button>
          <%
        } else{
        }
        %>
      <button type="button" onclick="location.href = './list.jsp'">목록</button>
    </div>
  </fieldset>

  <jsp:include page="/menu/bottom.jsp" flush='false' />
</body>
</html>
</html>